package code.blurone.snifferexploited

import org.bukkit.GameMode
import org.bukkit.Material
import org.bukkit.craftbukkit.v1_20_R1.entity.CraftPlayer
import org.bukkit.craftbukkit.v1_20_R1.entity.CraftSniffer
import org.bukkit.entity.EntityType
import org.bukkit.entity.Sniffer
import org.bukkit.event.EventHandler
import org.bukkit.event.Listener
import org.bukkit.event.player.PlayerInteractEntityEvent
import org.bukkit.inventory.EquipmentSlot
import org.bukkit.metadata.FixedMetadataValue
import org.bukkit.plugin.java.JavaPlugin

class SnifferExploited : JavaPlugin(), Listener {
    override fun onEnable() {
        // Plugin startup logic
        server.pluginManager.registerEvents(this, this)
    }

    override fun onDisable() {
        // Plugin shutdown logic
    }

    @EventHandler
    fun playerInteractEvent(event: PlayerInteractEntityEvent)
    {
        if (event.rightClicked.type != EntityType.SNIFFER || event.player.gameMode == GameMode.SPECTATOR ||
            (event.hand == EquipmentSlot.HAND && !(event.player.inventory.itemInMainHand.type == Material.SUGAR || event.player.inventory.itemInMainHand.type == Material.LEGACY_SUGAR)) ||
            (event.hand == EquipmentSlot.OFF_HAND && !(event.player.inventory.itemInOffHand.type == Material.SUGAR || event.player.inventory.itemInOffHand.type == Material.LEGACY_SUGAR)))
            return

        if (event.player.gameMode != GameMode.CREATIVE) {
            val sugarStack = if (event.hand == EquipmentSlot.HAND) event.player.inventory.itemInMainHand else event.player.inventory.itemInOffHand
            sugarStack.amount--
        }

        val sniffer = event.rightClicked as CraftSniffer

        if (!sniffer.hasMetadata("SnifferExploited.HighOnSugar"))
        {
            sniffer.setMetadata("SnifferExploited.HighOnSugar", FixedMetadataValue(this, true))
            sniffer.handle.goalSelector.removeAllGoals { it.stop(); true }
            sniffer.handle.navigation.stop()
            sniffer.handle.lookAt((event.player as CraftPlayer).handle, 180.0f, 180.0f)
            sniffer.state = Sniffer.State.SNIFFING
            sniffer.handle.goalSelector.addGoal(0, RunAroundLikeHighOnSugarGoal(sniffer))
        }
        else
            sniffer.handle.goalSelector.runningGoals.toArray().let { if (it.isNotEmpty()) (it[0] as RunAroundLikeHighOnSugarGoal).potentiate() }
    }
}
