package code.blurone.snifferexploited

import net.minecraft.world.level.block.entity.BrewingStandBlockEntity
import org.bukkit.Color
import org.bukkit.craftbukkit.v1_20_R1.inventory.CraftItemStack
import org.bukkit.event.EventHandler
import org.bukkit.event.EventPriority
import org.bukkit.event.Listener
import org.bukkit.event.inventory.BrewEvent
import org.bukkit.inventory.meta.PotionMeta
import org.bukkit.potion.PotionData
import org.bukkit.potion.PotionType
import java.util.logging.Logger

class ExperimentalPotionListener(private val logger: Logger) : Listener {
    val craftMetaPotionClass = Class.forName("org.bukkit.craftbukkit.v1_20_R1.inventory.CraftMetaPotion")

    @EventHandler(priority = EventPriority.HIGHEST)
    fun brewFinishEvent(event: BrewEvent)
    {
        event.contents.ingredient

        event.results.forEach {
            if ((it.itemMeta as? PotionMeta)?.basePotionData?.type != PotionType.UNCRAFTABLE) return@forEach

            val nmsCopy = CraftItemStack.asNMSCopy(it)

            val isLong = nmsCopy.orCreateTag.getString("Potion").contains("long")
            val isStrong = nmsCopy.orCreateTag.getString("Potion").contains("strong")

            if (nmsCopy.orCreateTag.getString("Potion").contains("glowing"))
                it.itemMeta = (it.itemMeta as? PotionMeta)?.run {
                    setDisplayName("Potion of Glowing")
                    color = Color.BLACK
                    return@run this
                }
            else if (nmsCopy.orCreateTag.getString("Potion").contains("hunger"))
                it.itemMeta = (it.itemMeta as? PotionMeta)?.run {
                    setDisplayName("Potion of Hunger ${if (isStrong) "II" else ""}")
                    color = Color.BLACK
                    return@run this
                }
            else logger.info("Unknown potion: ${nmsCopy.orCreateTag.getString("Potion")}")
        }
    }

    /*
    OK, MIRA, TE EXPLICO LO QUE VAS A TENER QUE HACER:
    PRIMERO VAS A TENER QUE CAMBIAR EN EL REGISTRO, DE LAS POCIONES NUEVAS A UNCRAFTEABLE, A TODAS
    DESPUES ACA CHECKEAS CADA VEZ QUE SE HACE UN UNCRAFTEABLE Y PARA SABER QUE HACER CON ESA POCION USAS event.contents
    SI ES QUE event.contents SE ACTUALIZA, TE HACES UN fun CON EL EVENTO DE EMPEZAR UN BREWING
    Y TE GUARDAS LAS VARIABLES EN UN MAP CON LAS COORDS DEL BREWING STAND

    SI ES DE SER QUE ESTO FUNCIONA, YA ESTÁ, Y EVITAMOS BANDA DE CORRUPCIÓN DE REGISTROS Y ESA MIERDA,
    ADEMÁS PODES AÑADIR QUE EL OJO FERMENTADO CAMBIE LA DE GLOWING A DARKNESS Y QUE LA DE HUNGER SE TRANSFORME EN MIEL

    good night
    - blur
     */
}